name: Build SukiSU Ultra 40129

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device codename'
        required: true
        default: 'oneplus_ace5_ultra_b'
        type: choice
        options:
          - oneplus_ace5_ultra_b
      cpu:
        description: 'CPU codename'
        required: true
        default: 'MT6991'
        type: choice
        options:
          - MT6991
      kernel:
        description: 'Kernel version'
        required: true
        default: '6.6'
        type: choice
        options:
          - '6.6'
      kpm:
        description: 'Enable KPM'
        required: true
        default: 'y'
        type: choice
        options:
          - 'y'
          - 'n'
      susfs:
        description: 'Enable SUSFS (OnePlus: disable)'
        required: true
        default: 'n'
        type: choice
        options:
          - 'y'
          - 'n'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up build environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git-core clang llvm lld gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi bc bison flex libssl-dev libelf-dev python3-pip
          pip3 install pycryptodome
          git config --global --add safe.directory '*'

      - name: Download kernel source
        run: |
          git clone --depth=1 https://github.com/ParticleG/android_kernel_oneplus_mt6991.git kernel
          cd kernel

      - name: Apply SukiSU Ultra 40129 patches
        run: |
          cd kernel
          git clone --depth=1 https://github.com/SukiSU/SukiSU-Ultra.git sukisu
          patch -p1 < sukisu/patches/6.6/sukisu.patch
          patch -p1 < sukisu/patches/6.6/40129.patch
          if [ "${{ github.event.inputs.kpm }}" = "y" ]; then
            patch -p1 < sukisu/patches/6.6/kpm.patch
          fi

      - name: Configure build parameters
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          export LLVM_IAS=1
          make oneplus_ace5_ultra_b_defconfig
          if [ "${{ github.event.inputs.susfs }}" = "n" ]; then
            scripts/config --disable CONFIG_SUSFS
          fi
          if [ "${{ github.event.inputs.kpm }}" = "y" ]; then
            scripts/config --enable CONFIG_KPM
          fi
          make savedefconfig

      - name: Compile kernel
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          export LLVM_IAS=1
          make -j$(nproc) Image.gz dtbo.img
          mkdir -p ../AnyKernel3
          cp arch/arm64/boot/Image.gz ../AnyKernel3/
          cp arch/arm64/boot/dtbo.img ../AnyKernel3/
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ../AnyKernel3-Template
          cp -r ../AnyKernel3-Template/* ../AnyKernel3/
          echo "ui_print(\"Flashing SukiSU Ultra 40129 for OnePlus Ace 5 Ultra...\");" > ../AnyKernel3/META-INF/com/google/android/updater-script
          echo "package_extract_file(\"Image.gz\", \"/dev/block/bootdevice/by-name/boot\");" >> ../AnyKernel3/META-INF/com/google/android/updater-script
          echo "package_extract_file(\"dtbo.img\", \"/dev/block/bootdevice/by-name/dtbo\");" >> ../AnyKernel3/META-INF/com/google/android/updater-script
          echo "ui_print(\"SukiSU Ultra 40129 flashed successfully!\");" >> ../AnyKernel3/META-INF/com/google/android/updater-script

      - name: Package kernel
        run: |
          cd AnyKernel3
          zip -r9 ../SukiSU-Ultra-40129-Ace5-Ultra-${{ github.run_id }}.zip . -x "*.git*" "*.md" "LICENSE"
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-40129-Ace5-Ultra.zip
          path: SukiSU-Ultra-40129-Ace5-Ultra-${{ github.run_id }}.zip
          retention-days: 7
